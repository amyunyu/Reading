import React, { useState, useEffect, useMemo } from 'react';
import { 
  BookOpen, Search, Library, BarChart2, Plus, Book, Star, 
  ChevronLeft, Clock, Bookmark, Trash2, Edit3, Calendar, 
  Leaf, Target, Tag, X, Flame, Trophy, TrendingUp, Sparkles,
  Loader2, Wand2, Compass, BrainCircuit, BookText, LibraryBig
} from 'lucide-react';

const STATUS = { WANT: '想讀', READING: '閱讀中', FINISHED: '已完讀' };

// --- Gemini API Configuration ---
const apiKey = ""; 
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

const App = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [books, setBooks] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [isSearching, setIsSearching] = useState(false);
  const [selectedBook, setSelectedBook] = useState(null);
  const [isDetailOpen, setIsDetailOpen] = useState(false);
  
  const [yearlyGoal, setYearlyGoal] = useState(12);
  const [showGoalSetter, setShowGoalSetter] = useState(false);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiRecommendation, setAiRecommendation] = useState(null);

  // --- Persistence ---
  useEffect(() => {
    const savedBooks = localStorage.getItem('bibliTrack_ai_books');
    const savedGoal = localStorage.getItem('bibliTrack_ai_goal');
    if (savedBooks) setBooks(JSON.parse(savedBooks));
    if (savedGoal) setYearlyGoal(parseInt(savedGoal));
  }, []);

  useEffect(() => {
    localStorage.setItem('bibliTrack_ai_books', JSON.stringify(books));
    localStorage.setItem('bibliTrack_ai_goal', yearlyGoal.toString());
  }, [books, yearlyGoal]);

  // --- Gemini API Helper ---
  const callGemini = async (prompt, systemInstruction = "") => {
    setIsAiLoading(true);
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
          })
        });
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (error) {
        if (i === 4) {
          alert("AI 暫時休息中，請稍後再試。");
          return null;
        }
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      } finally {
        if (i === 4 || !isAiLoading) setIsAiLoading(false);
      }
    }
  };

  // --- AI Features ---
  const generateAiSummary = async (book) => {
    const prompt = `請為這本書提供大約 300 字的精華導讀。書名：《${book.title}》，作者：${book.author}。
    內容需包含：1. 核心主題摘要 2. 給讀者的建議 3. 三個關鍵知識點。請使用繁體中文，語氣溫暖且專業。`;
    const summary = await callGemini(prompt, "你是一位資深的讀書博主，擅長撰寫吸引人的書評導讀。");
    if (summary) updateBook(book.id, { aiSummary: summary });
  };

  const beautifyNote = async (book, noteText) => {
    if (!noteText.trim()) return;
    const prompt = `這是我的讀書筆記：『${noteText}』。這本書是《${book.title}》。
    請幫我將這段筆記美化成結構化的書評摘要，包含「摘要」、「深度心得」與「推薦金句」。請保持我的原意，但讓文筆更優美。請使用繁體中文。`;
    const beautifulNote = await callGemini(prompt, "你是一位文筆優美的文學評論家。");
    return beautifulNote;
  };

  const getAiRecommendations = async () => {
    const finishedBooks = books.filter(b => b.status === STATUS.FINISHED).map(b => `《${b.title}》(${b.rating}星)`).join(', ');
    if (!finishedBooks) {
      alert("請先標記幾本「已完讀」並評分的書籍，AI 才能了解你的品味！");
      return;
    }
    const prompt = `根據我已讀完的書籍清單：[${finishedBooks}]，請推薦 3 本我可能會感興趣的新書。
    對於每本書，請提供書名、推薦原因以及適合在哪種心情下閱讀。請使用繁體中文，格式清晰。`;
    const recommendations = await callGemini(prompt, "你是一位懂書的智慧導航員，擅長挖掘讀者的潛在興趣。");
    if (recommendations) setAiRecommendation(recommendations);
  };

  const updateBook = (id, updates) => {
    setBooks(prev => prev.map(b => b.id === id ? { ...b, ...updates } : b));
    if (selectedBook?.id === id) setSelectedBook(prev => ({ ...prev, ...updates }));
  };

  const stats = useMemo(() => {
    const now = new Date();
    const oneYearAgo = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000));
    const rollingYearFinished = books.filter(b => b.status === STATUS.FINISHED && b.dateFinished && new Date(b.dateFinished) > oneYearAgo);
    return {
      rollingCount: rollingYearFinished.length,
      progress: yearlyGoal > 0 ? Math.min(Math.round((rollingYearFinished.length / yearlyGoal) * 100), 100) : 0
    };
  }, [books, yearlyGoal]);

  const handleSearch = async (e) => {
    if (e) e.preventDefault();
    if (!searchQuery.trim()) return;
    setIsSearching(true);
    try {
      const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(searchQuery)}&maxResults=10`);
      const data = await res.json();
      if (data.items) {
        setSearchResults(data.items.map(item => ({
          id: item.id,
          title: item.volumeInfo.title,
          author: item.volumeInfo.authors?.[0] || '未知作者',
          cover: item.volumeInfo.imageLinks?.thumbnail || 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=200',
          pages: item.volumeInfo.pageCount || 200,
          tags: [],
          notes: []
        })));
      }
    } catch (err) { console.error(err); } finally { setIsSearching(false); }
  };

  // --- 新的 AI Logo 組件 ---
  const AiLogo = () => (
    <div className="relative">
      <div className="w-10 h-10 bg-emerald-700/5 rounded-2xl flex items-center justify-center border border-emerald-100/50">
        <BookText size={20} strokeWidth={1.5} className="text-emerald-700" />
      </div>
      <div className="absolute -top-1 -right-1">
        <Sparkles size={12} className="text-amber-500 animate-pulse" fill="currentColor" />
      </div>
    </div>
  );

  return (
    <div className="max-w-md mx-auto h-screen bg-[#FBFDFA] flex flex-col overflow-hidden relative shadow-2xl transition-all duration-500" 
         style={{ fontFamily: "'Klee One', cursive, sans-serif" }}>
      
      {/* 注入 Klee One 字體 */}
      <style>
        {`@import url('https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap');`}
      </style>
      
      {/* AI 載入指示器 */}
      {isAiLoading && (
        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[100] bg-emerald-800/80 backdrop-blur-md text-white px-4 py-1.5 rounded-full shadow-lg flex items-center gap-2 animate-pulse">
          <Sparkles size={12} className="text-amber-300" />
          <span className="text-[10px] font-medium tracking-widest uppercase">AI Insight</span>
        </div>
      )}

      {/* Header */}
      <header className="px-6 pt-12 pb-4 shrink-0 flex justify-between items-center z-30">
        <div className="flex items-center gap-3">
          <AiLogo />
          <div>
            <h1 className="text-xl font-semibold text-emerald-950 tracking-wide">書跡 AI</h1>
            <p className="text-[9px] text-emerald-600/40 font-medium uppercase tracking-widest -mt-1">BibliTrack Smart</p>
          </div>
        </div>
        <button onClick={() => setShowGoalSetter(true)} className="w-9 h-9 bg-white border border-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 transition-all">
          <Target size={18} strokeWidth={1.5} />
        </button>
      </header>

      <main className="flex-1 overflow-y-auto pb-24 px-6">
        {activeTab === 'home' && (
          <div className="space-y-10 animate-in fade-in duration-700 pt-2">
            {/* 年度目標卡片 */}
            <section className="bg-emerald-800/90 p-8 rounded-[2rem] text-white shadow-xl shadow-emerald-100 relative overflow-hidden">
              <Sparkles className="absolute -right-6 -top-6 text-white/5" size={120} />
              <p className="text-emerald-200/60 text-[10px] font-medium uppercase tracking-[0.25em] mb-2">My Reading Journey</p>
              <h2 className="text-4xl font-semibold mb-6 tracking-tight">{stats.rollingCount} / {yearlyGoal} <span className="text-sm font-normal opacity-30 tracking-normal ml-1">Books</span></h2>
              <div className="space-y-3">
                <div className="flex justify-between text-[10px] font-medium tracking-widest text-emerald-300 uppercase">
                   <span>Goal Progress {stats.progress}%</span>
                   <span>{Math.max(0, yearlyGoal - stats.rollingCount)} Left</span>
                </div>
                <div className="h-1.5 w-full bg-emerald-950/20 rounded-full overflow-hidden">
                  <div className="h-full bg-gradient-to-r from-emerald-300 to-emerald-100 rounded-full transition-all duration-1000 ease-out" style={{ width: `${stats.progress}%` }} />
                </div>
              </div>
            </section>

            {/* AI 智慧推薦 */}
            <section className="bg-white p-6 rounded-[2rem] border border-emerald-50 shadow-sm">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-sm font-semibold text-emerald-900 flex items-center gap-2">
                  <Compass size={16} strokeWidth={1.5} className="text-emerald-500" /> 靈感發現
                </h3>
                <button 
                  onClick={getAiRecommendations}
                  className="w-10 h-10 bg-emerald-600 text-white rounded-xl active:scale-90 transition-all shadow-md flex items-center justify-center"
                >
                  <Wand2 size={16} strokeWidth={1.5} />
                </button>
              </div>
              
              {aiRecommendation ? (
                <div className="bg-emerald-50/30 rounded-2xl p-5 text-[13px] text-emerald-900/70 leading-relaxed whitespace-pre-wrap border border-emerald-100/30">
                  {aiRecommendation}
                </div>
              ) : (
                <div className="py-4 text-center">
                   <p className="text-emerald-800/30 text-[13px] italic">想讀什麼？讓 AI 推薦你的下一段旅程</p>
                </div>
              )}
            </section>

            {/* 正在閱讀 */}
            <section>
              <h3 className="text-sm font-semibold text-emerald-950 mb-5 flex items-center gap-2 px-1">
                <Clock size={16} strokeWidth={1.5} className="text-emerald-500" /> 目前進度
              </h3>
              <div className="space-y-5">
                {books.filter(b => b.status === STATUS.READING).map(book => (
                  <div key={book.id} onClick={() => { setSelectedBook(book); setIsDetailOpen(true); }} className="bg-white p-5 rounded-[2rem] border border-emerald-50 shadow-sm flex gap-5 active:scale-[0.98] transition-all">
                    <img src={book.cover} className="w-16 h-24 object-cover rounded-xl shadow-sm" alt="" />
                    <div className="flex-1 py-1 flex flex-col justify-between min-w-0">
                      <h4 className="font-semibold text-emerald-950 text-[15px] truncate">{book.title}</h4>
                      <div className="h-1 w-full bg-emerald-50 rounded-full overflow-hidden my-2">
                        <div className="h-full bg-emerald-500/60" style={{ width: `${(book.currentPage/book.pages)*100}%` }} />
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-[10px] text-emerald-800/40 font-medium tracking-wider">{Math.round((book.currentPage/book.pages)*100)}% Completed</span>
                        {book.aiSummary && <Sparkles size={10} className="text-amber-400" fill="currentColor" />}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          </div>
        )}

        {/* 藏書空間 */}
        {activeTab === 'library' && (
          <div className="space-y-6 animate-in fade-in duration-500 pt-4">
            <h2 className="text-xl font-semibold text-emerald-950">藏書空間</h2>
            <div className="grid gap-4">
              {books.map(book => (
                <div key={book.id} onClick={() => { setSelectedBook(book); setIsDetailOpen(true); }} className="bg-white p-4 rounded-[1.8rem] border border-emerald-50 shadow-sm flex gap-4 items-center active:scale-[0.98] transition-all">
                  <img src={book.cover} className="w-12 h-18 object-cover rounded-lg" alt="" />
                  <div className="flex-1 min-w-0">
                    <h4 className="font-semibold text-emerald-950 text-sm truncate">{book.title}</h4>
                    <div className="flex gap-2 mt-2">
                       <span className="text-[9px] px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded-md font-medium tracking-wider">{book.status}</span>
                       {book.aiSummary && <span className="text-[9px] px-2 py-0.5 bg-amber-50 text-amber-700 rounded-md font-medium tracking-wider">AI Insight</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 搜尋 */}
        {activeTab === 'search' && (
          <div className="animate-in fade-in duration-500 pt-4">
            <h2 className="text-xl font-semibold text-emerald-950 mb-6">添購智慧</h2>
            <form onSubmit={handleSearch} className="relative mb-8">
              <input type="text" placeholder="探索書名、作者或靈感..." className="w-full pl-12 pr-4 py-4 bg-white rounded-[1.5rem] shadow-sm border border-emerald-50 focus:ring-1 focus:ring-emerald-200 transition-all outline-none text-sm placeholder:text-emerald-200" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-200" size={16} />
            </form>
            <div className="grid gap-4">
              {isSearching ? (
                 <div className="py-20 flex flex-col items-center gap-4 text-emerald-100">
                    <Loader2 className="animate-spin" size={24} />
                    <p className="text-[10px] font-medium tracking-widest uppercase">Searching...</p>
                 </div>
              ) : searchResults.map(book => (
                <div key={book.id} onClick={() => {
                  if(books.find(b => b.id === book.id)) return;
                  setBooks([...books, { ...book, status: STATUS.WANT, currentPage: 0, rating: 0, dateAdded: new Date().toISOString() }]);
                  setActiveTab('library');
                }} className="bg-white p-4 rounded-[1.5rem] border border-emerald-50 flex gap-4 items-center active:scale-95 transition-all">
                  <img src={book.cover} className="w-12 h-18 object-cover rounded-md" alt="" />
                  <div className="flex-1">
                    <p className="font-semibold text-[13px] text-emerald-950 line-clamp-1">{book.title}</p>
                    <p className="text-[10px] text-emerald-800/40 font-medium">{book.author}</p>
                  </div>
                  <Plus size={18} strokeWidth={1.5} className="text-emerald-400" />
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 統計 */}
        {activeTab === 'stats' && (
          <div className="space-y-8 animate-in slide-in-from-right duration-500 pt-4 text-center">
            <h2 className="text-xl font-semibold text-emerald-950">閱讀記錄</h2>
            <div className="bg-white border border-emerald-50 p-12 rounded-[3rem] shadow-sm flex flex-col items-center gap-6">
               <div className="w-20 h-20 bg-emerald-50 rounded-3xl flex items-center justify-center text-emerald-600/60 rotate-6 shadow-sm">
                  <LibraryBig size={40} strokeWidth={1} />
               </div>
               <div>
                <p className="text-emerald-800/30 text-[10px] font-medium uppercase tracking-[0.2em] mb-2">Total Finished</p>
                <h3 className="text-6xl font-semibold text-emerald-950 tracking-tighter">{books.filter(b => b.status === STATUS.FINISHED).length} <span className="text-base font-normal text-emerald-200 tracking-normal ml-1">Books</span></h3>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* Footer Nav */}
      <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-xl border-t border-emerald-50 px-10 py-5 flex justify-between items-center z-40 pb-9">
        {[
          { id: 'home', icon: Bookmark, label: '首頁' },
          { id: 'library', icon: Library, label: '館藏' },
          { id: 'search', icon: Search, label: '搜尋' },
          { id: 'stats', icon: BarChart2, label: '統計' }
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1.5 transition-all duration-300 ${activeTab === tab.id ? 'text-emerald-700 scale-105' : 'text-emerald-100 hover:text-emerald-300'}`}>
            <tab.icon size={20} fill={activeTab === tab.id ? 'currentColor' : 'none'} strokeWidth={activeTab === tab.id ? 1.5 : 2} />
            <span className={`text-[9px] font-medium tracking-widest uppercase ${activeTab === tab.id ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>{tab.label}</span>
          </button>
        ))}
      </nav>

      {/* 目標設定 */}
      {showGoalSetter && (
        <div className="absolute inset-0 z-[60] bg-emerald-950/20 backdrop-blur-sm flex items-center justify-center p-8">
          <div className="bg-white w-full p-12 rounded-[3rem] shadow-2xl animate-in zoom-in duration-300 text-center border border-emerald-50">
            <h3 className="text-lg font-semibold text-emerald-950 mb-10 tracking-wide">設定年度目標</h3>
            <div className="flex items-center justify-center gap-8 mb-12">
              <button onClick={() => setYearlyGoal(Math.max(1, yearlyGoal - 1))} className="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-700 text-2xl font-light">-</button>
              <span className="text-6xl font-semibold text-emerald-900 tracking-tighter">{yearlyGoal}</span>
              <button onClick={() => setYearlyGoal(yearlyGoal + 1)} className="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-700 text-2xl font-light">+</button>
            </div>
            <button onClick={() => setShowGoalSetter(false)} className="w-full py-4 bg-emerald-700 text-white rounded-2xl font-medium shadow-lg shadow-emerald-200 text-sm tracking-widest uppercase">Save Goals</button>
          </div>
        </div>
      )}

      {/* 書籍詳情 */}
      {isDetailOpen && selectedBook && (
        <div className="absolute inset-0 bg-[#FBFDFA] z-50 flex flex-col animate-in slide-in-from-right duration-500 overflow-y-auto pb-24">
          <div className="p-6 pt-12 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur-md z-10 border-b border-emerald-50">
            <button onClick={() => setIsDetailOpen(false)} className="w-10 h-10 bg-white rounded-2xl flex items-center justify-center border border-emerald-50 shadow-sm"><ChevronLeft size={18} strokeWidth={1.5} /></button>
            <span className="text-[10px] font-semibold text-emerald-950 tracking-[0.3em] uppercase opacity-50">Book Archive</span>
            <button onClick={() => { if(confirm("確定移除這本書籍？")) { setBooks(prev => prev.filter(b => b.id !== selectedBook.id)); setIsDetailOpen(false); }}} className="w-10 h-10 bg-white rounded-2xl flex items-center justify-center border border-rose-50 text-rose-300 shadow-sm"><Trash2 size={16} strokeWidth={1.5} /></button>
          </div>
          
          <div className="p-6 space-y-12">
            <div className="flex gap-8 items-start">
              <img src={selectedBook.cover} className="w-32 h-44 object-cover rounded-[1.5rem] shadow-xl border-4 border-white" alt="" />
              <div className="flex-1 pt-2">
                <h2 className="text-xl font-semibold leading-relaxed text-emerald-950 mb-1">{selectedBook.title}</h2>
                <p className="text-emerald-700/40 font-medium text-[11px] mb-6 tracking-wide italic">{selectedBook.author}</p>
                <div className="flex items-center gap-1.5 mb-8">
                  {[1, 2, 3, 4, 5].map(s => <Star key={s} size={20} fill={s <= selectedBook.rating ? '#fbbf24' : 'none'} className={s <= selectedBook.rating ? 'text-amber-400' : 'text-emerald-50'} onClick={() => updateBook(selectedBook.id, { rating: s })} />)}
                </div>
                <select className="w-full bg-emerald-50/50 border border-emerald-50 rounded-xl py-3 px-4 font-medium text-[11px] text-emerald-800 focus:ring-1 focus:ring-emerald-200 outline-none tracking-widest uppercase" value={selectedBook.status} onChange={(e) => updateBook(selectedBook.id, { status: e.target.value })}>
                  {Object.values(STATUS).map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
            </div>

            {/* AI 導讀 */}
            <section className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-amber-50/50 relative">
               <div className="flex justify-between items-center mb-6">
                 <h4 className="text-[10px] font-semibold text-amber-600 uppercase tracking-[0.25em] flex items-center gap-2">
                   <Sparkles size={14} className="opacity-60" fill="currentColor" /> AI Insight
                 </h4>
                 {!selectedBook.aiSummary && (
                   <button 
                     onClick={() => generateAiSummary(selectedBook)}
                     className="px-4 py-2 bg-amber-500/10 text-amber-600 text-[10px] font-semibold rounded-xl hover:bg-amber-500/20 transition-all tracking-wider"
                   >
                     分析內容
                   </button>
                 )}
               </div>
               {selectedBook.aiSummary ? (
                 <div className="text-[13px] text-emerald-900/60 leading-[1.8] font-normal whitespace-pre-wrap border-l border-amber-100/50 pl-5">
                   {selectedBook.aiSummary}
                 </div>
               ) : (
                 <p className="text-[12px] text-emerald-800/20 italic text-center py-4">點擊分析，AI 將為您導讀這本書的核心內容</p>
               )}
            </section>

            {/* 進度控制 */}
            <div className="bg-emerald-900/90 p-10 rounded-[3rem] text-white shadow-lg space-y-10">
                <h4 className="text-[9px] font-medium text-emerald-300 uppercase tracking-[0.3em] flex items-center gap-2 opacity-50">
                  <BookOpen size={12} strokeWidth={1.5} /> Current Milestone
                </h4>
                <div className="flex items-center gap-10">
                   <div className="flex-1 flex flex-col items-center gap-4">
                      <input type="number" value={selectedBook.currentPage} onChange={(e) => updateBook(selectedBook.id, { currentPage: Math.min(parseInt(e.target.value)||0, selectedBook.pages) })} className="w-full bg-white/5 rounded-3xl py-5 px-2 font-semibold text-4xl text-white text-center shadow-inner border border-white/10 outline-none focus:bg-white/10 transition-all" />
                      <span className="text-[8px] font-medium text-emerald-400 uppercase tracking-widest">Page Now</span>
                   </div>
                   <div className="text-emerald-700 font-light text-4xl">/</div>
                   <div className="flex-1 flex flex-col items-center gap-4">
                      <div className="w-full bg-emerald-950/20 rounded-3xl py-5 px-2 font-semibold text-4xl text-emerald-500/80 text-center border border-white/5">{selectedBook.pages}</div>
                      <span className="text-[8px] font-medium text-emerald-400 uppercase tracking-widest">Total Page</span>
                   </div>
                </div>
            </div>

            {/* 心得筆記 */}
            <section className="space-y-6">
              <div className="flex justify-between items-center px-2">
                <h4 className="text-sm font-semibold text-emerald-950">隨手札記</h4>
                <button 
                    onClick={async () => {
                      const el = document.getElementById('detail-note');
                      if(!el.value) return;
                      const beautiful = await beautifyNote(selectedBook, el.value);
                      if (beautiful) el.value = beautiful;
                    }}
                    className="flex items-center gap-1.5 px-4 py-2 bg-emerald-600/5 text-emerald-700 rounded-full text-[10px] font-semibold active:scale-95 transition-all border border-emerald-100/30"
                  >
                    <Wand2 size={12} strokeWidth={1.5} /> AI 修辭
                  </button>
              </div>
              
              <div className="bg-white p-2 rounded-[2.5rem] shadow-sm border border-emerald-50">
                <textarea id="detail-note" placeholder="在此處記錄您的閱讀感悟..." className="w-full bg-transparent border-none rounded-3xl p-6 text-[14px] outline-none min-h-[180px] text-emerald-950/80 placeholder:text-emerald-100 leading-[1.8]"></textarea>
                <button onClick={() => { 
                  const el = document.getElementById('detail-note'); 
                  if(el.value) { 
                    updateBook(selectedBook.id, { notes: [{ id: Date.now(), text: el.value, date: new Date().toLocaleDateString() }, ...(selectedBook.notes||[])] }); 
                    el.value = ''; 
                  }
                }} className="w-full py-5 bg-emerald-800 text-white rounded-[1.8rem] font-medium text-[13px] tracking-[0.2em] shadow-lg shadow-emerald-200 uppercase">儲存札記</button>
              </div>
              
              <div className="space-y-6 pt-4">
                {selectedBook.notes?.map(n => (
                  <div key={n.id} className="bg-white p-7 rounded-[2rem] border border-emerald-50/50 shadow-sm relative">
                    <p className="text-[14px] text-emerald-900/60 leading-[1.8] font-normal italic">「{n.text}」</p>
                    <div className="flex items-center gap-2 text-[9px] text-emerald-200 font-medium uppercase mt-5 pt-4 border-t border-emerald-50/50 tracking-widest">
                      <Calendar size={10} strokeWidth={1.5} /> {n.date}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;