<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書跡 AI Pro - 舒心閱讀伴侶</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Klee One -->
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Klee One', cursive, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-[#FBFDFA] text-slate-800">

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col overflow-hidden relative shadow-2xl bg-[#FBFDFA]">
        
        <!-- AI Loading Overlay -->
        <div id="ai-loader" class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-[100] bg-emerald-800/80 backdrop-blur-md text-white px-4 py-1.5 rounded-full shadow-lg flex items-center gap-2 animate-pulse">
            <i data-lucide="sparkles" class="w-3 h-3 text-amber-300"></i>
            <span class="text-[10px] font-medium tracking-widest uppercase">AI Insight</span>
        </div>

        <!-- Header -->
        <header class="px-6 pt-12 pb-4 shrink-0 flex justify-between items-center z-30">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-10 h-10 bg-emerald-700/5 rounded-2xl flex items-center justify-center border border-emerald-100/50">
                        <i data-lucide="book-text" class="text-emerald-700 w-5 h-5"></i>
                    </div>
                    <div class="absolute -top-1 -right-1">
                        <i data-lucide="sparkles" class="w-3 h-3 text-amber-500 fill-current animate-pulse"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-emerald-950 tracking-wide">書跡 AI</h1>
                    <p class="text-[9px] text-emerald-600/40 font-medium uppercase tracking-widest -mt-1">BibliTrack Smart</p>
                </div>
            </div>
            <button onclick="toggleGoalSetter(true)" class="w-9 h-9 bg-white border border-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm active:scale-90 transition-all">
                <i data-lucide="target" class="w-4.5 h-4.5"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto pb-24 px-6 hide-scrollbar">
            <!-- Dynamic Content Injected Here -->
        </main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-xl border-t border-emerald-50 px-10 py-5 flex justify-between items-center z-40 pb-9">
            <button onclick="switchTab('home')" id="nav-home" class="nav-btn flex flex-col items-center gap-1.5 transition-all duration-300 text-emerald-700">
                <i data-lucide="bookmark" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium tracking-widest uppercase">首頁</span>
            </button>
            <button onclick="switchTab('library')" id="nav-library" class="nav-btn flex flex-col items-center gap-1.5 transition-all duration-300 text-emerald-100">
                <i data-lucide="library" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium tracking-widest uppercase">館藏</span>
            </button>
            <button onclick="switchTab('search')" id="nav-search" class="nav-btn flex flex-col items-center gap-1.5 transition-all duration-300 text-emerald-100">
                <i data-lucide="search" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium tracking-widest uppercase">搜尋</span>
            </button>
            <button onclick="switchTab('stats')" id="nav-stats" class="nav-btn flex flex-col items-center gap-1.5 transition-all duration-300 text-emerald-100">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium tracking-widest uppercase">統計</span>
            </button>
        </nav>

        <!-- Overlays -->
        <div id="goal-setter" class="hidden absolute inset-0 z-[60] bg-emerald-950/20 backdrop-blur-sm flex items-center justify-center p-8">
            <div class="bg-white w-full p-10 rounded-[3rem] shadow-2xl text-center border border-emerald-50">
                <h3 class="text-lg font-semibold text-emerald-950 mb-8">計畫年度目標</h3>
                <div class="flex items-center justify-center gap-8 mb-10">
                    <button onclick="adjustGoal(-1)" class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-700 text-2xl font-light">-</button>
                    <span id="goal-value" class="text-5xl font-semibold text-emerald-900 tracking-tighter">12</span>
                    <button onclick="adjustGoal(1)" class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-700 text-2xl font-light">+</button>
                </div>
                <button onclick="toggleGoalSetter(false)" class="w-full py-4 bg-emerald-700 text-white rounded-2xl font-medium shadow-lg shadow-emerald-100/50 uppercase text-sm tracking-widest">儲存計畫</button>
            </div>
        </div>

        <div id="book-detail" class="hidden absolute inset-0 bg-[#FBFDFA] z-50 flex flex-col overflow-y-auto pb-24">
            <!-- Detail Content Injected Here -->
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            activeTab: 'home',
            books: JSON.parse(localStorage.getItem('bibliTrack_html_books')) || [],
            yearlyGoal: parseInt(localStorage.getItem('bibliTrack_html_goal')) || 12,
            isAiLoading: false,
            aiRecommendation: null,
            searchResults: [],
            isSearching: false
        };

        const apiKey = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const STATUS = { WANT: '想讀', READING: '閱讀中', FINISHED: '已完讀' };

        // --- Persistence ---
        function saveToStorage() {
            localStorage.setItem('bibliTrack_html_books', JSON.stringify(state.books));
            localStorage.setItem('bibliTrack_html_goal', state.yearlyGoal.toString());
        }

        // --- Gemini API ---
        async function callGemini(prompt, systemInstruction = "") {
            toggleAiLoader(true);
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    toggleAiLoader(false);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    if (i === 4) {
                        alert("AI 暫時休息中。");
                        toggleAiLoader(false);
                        return null;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // --- Render Functions ---
        function render() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';

            if (state.activeTab === 'home') {
                renderHome(main);
            } else if (state.activeTab === 'library') {
                renderLibrary(main);
            } else if (state.activeTab === 'search') {
                renderSearch(main);
            } else if (state.activeTab === 'stats') {
                renderStats(main);
            }

            // Update Nav Styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-emerald-700');
                btn.classList.add('text-emerald-100');
                const icon = btn.querySelector('i');
                if (btn.id === `nav-${state.activeTab}`) {
                    btn.classList.add('text-emerald-700');
                    btn.classList.remove('text-emerald-100');
                }
            });

            lucide.createIcons();
        }

        function renderHome(container) {
            const rollingFinished = state.books.filter(b => b.status === STATUS.FINISHED && b.dateFinished && (new Date() - new Date(b.dateFinished)) < 365*24*60*60*1000).length;
            const progress = Math.min(Math.round((rollingFinished / state.yearlyGoal) * 100), 100);

            const section = document.createElement('div');
            section.className = 'space-y-10 pt-2 animate-in fade-in duration-700';
            section.innerHTML = `
                <section class="bg-emerald-800/90 p-8 rounded-[2rem] text-white shadow-xl relative overflow-hidden">
                    <p class="text-emerald-200/60 text-[10px] font-medium uppercase tracking-[0.25em] mb-2">Reading Marathon</p>
                    <h2 class="text-4xl font-semibold mb-6 tracking-tight">${rollingFinished} / ${state.yearlyGoal} <span class="text-sm font-normal opacity-30 ml-1">Books</span></h2>
                    <div class="space-y-3">
                        <div class="flex justify-between text-[10px] font-medium tracking-widest text-emerald-300 uppercase">
                           <span>Progress ${progress}%</span>
                           <span>${Math.max(0, state.yearlyGoal - rollingFinished)} Left</span>
                        </div>
                        <div class="h-1.5 w-full bg-emerald-950/20 rounded-full overflow-hidden">
                          <div class="h-full bg-emerald-300 rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-[2rem] border border-emerald-50 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-semibold text-emerald-900 flex items-center gap-2">
                            <i data-lucide="compass" class="w-4 h-4 text-emerald-500"></i> 靈感發現
                        </h3>
                        <button onclick="getRecommendations()" class="w-10 h-10 bg-emerald-600 text-white rounded-xl flex items-center justify-center shadow-md active:scale-90">
                            <i data-lucide="wand-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="ai-rec-box" class="text-[13px] text-emerald-900/70 leading-relaxed whitespace-pre-wrap">
                        ${state.aiRecommendation ? `<div class="bg-emerald-50/30 rounded-2xl p-5 border border-emerald-100/30">${state.aiRecommendation}</div>` : `<p class="text-center text-emerald-800/30 italic py-4">讓 AI 推薦你的下一段旅程</p>`}
                    </div>
                </section>

                <section>
                    <h3 class="text-sm font-semibold text-emerald-950 mb-5 px-1 flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4 text-emerald-500"></i> 目前進度
                    </h3>
                    <div class="space-y-5">
                        ${state.books.filter(b => b.status === STATUS.READING).map(book => `
                            <div onclick="openBookDetail('${book.id}')" class="bg-white p-5 rounded-[2rem] border border-emerald-50 shadow-sm flex gap-5 active:scale-[0.98] transition-all">
                                <img src="${book.cover}" class="w-16 h-24 object-cover rounded-xl shadow-sm">
                                <div class="flex-1 py-1 flex flex-col justify-between min-w-0">
                                    <h4 class="font-semibold text-emerald-950 text-[15px] truncate">${book.title}</h4>
                                    <div class="h-1 w-full bg-emerald-50 rounded-full overflow-hidden my-2">
                                        <div class="h-full bg-emerald-500/60" style="width: ${(book.currentPage/book.pages)*100}%"></div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-[10px] text-emerald-800/40 font-medium">${Math.round((book.currentPage/book.pages)*100)}% 已讀</span>
                                        ${book.aiSummary ? `<i data-lucide="sparkles" class="w-2.5 h-2.5 text-amber-400"></i>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<p class="text-center text-emerald-800/20 py-10 italic">點擊搜尋開始你的第一本書</p>'}
                    </div>
                </section>
            `;
            container.appendChild(section);
        }

        function renderLibrary(container) {
            container.innerHTML = `
                <div class="space-y-6 pt-4">
                    <h2 class="text-xl font-semibold text-emerald-950">藏書空間</h2>
                    <div class="grid gap-4">
                        ${state.books.map(book => `
                            <div onclick="openBookDetail('${book.id}')" class="bg-white p-4 rounded-[1.8rem] border border-emerald-50 shadow-sm flex gap-4 items-center active:scale-[0.98]">
                                <img src="${book.cover}" class="w-12 h-18 object-cover rounded-lg">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-semibold text-emerald-950 text-sm truncate">${book.title}</h4>
                                    <div class="flex gap-2 mt-2">
                                        <span class="text-[9px] px-2 py-0.5 bg-emerald-50 text-emerald-700 rounded-md font-medium uppercase tracking-wider">${book.status}</span>
                                        ${book.aiSummary ? `<span class="text-[9px] px-2 py-0.5 bg-amber-50 text-amber-700 rounded-md font-medium tracking-wider uppercase">AI Insight</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<p class="text-center text-emerald-800/30 py-20">書櫃目前是空的</p>'}
                    </div>
                </div>
            `;
        }

        function renderSearch(container) {
            container.innerHTML = `
                <div class="pt-4">
                    <h2 class="text-xl font-semibold text-emerald-950 mb-6">添購智慧</h2>
                    <form onsubmit="handleSearch(event)" class="relative mb-8">
                        <input id="search-input" type="text" placeholder="探索書名、作者..." class="w-full pl-12 pr-4 py-4 bg-white rounded-[1.5rem] shadow-sm border border-emerald-50 focus:ring-1 focus:ring-emerald-200 outline-none text-sm placeholder:text-emerald-200">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-200 w-4 h-4"></i>
                    </form>
                    <div id="search-results-list" class="grid gap-4">
                        ${state.isSearching ? `
                            <div class="py-20 flex flex-col items-center gap-4 text-emerald-100">
                                <i data-lucide="loader-2" class="animate-spin w-8 h-8"></i>
                                <p class="text-[10px] font-medium tracking-widest uppercase">Searching...</p>
                            </div>
                        ` : state.searchResults.map(book => `
                            <div onclick="addBook('${book.id}')" class="bg-white p-4 rounded-[1.5rem] border border-emerald-50 flex gap-4 items-center active:scale-95">
                                <img src="${book.cover}" class="w-12 h-18 object-cover rounded-md">
                                <div class="flex-1">
                                    <p class="font-semibold text-[13px] text-emerald-950 line-clamp-1">${book.title}</p>
                                    <p class="text-[10px] text-emerald-800/40 font-medium">${book.author}</p>
                                </div>
                                <i data-lucide="plus" class="text-emerald-400 w-5 h-5"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderStats(container) {
            const finished = state.books.filter(b => b.status === STATUS.FINISHED).length;
            container.innerHTML = `
                <div class="space-y-8 pt-4 text-center">
                    <h2 class="text-xl font-semibold text-emerald-950">閱讀記錄</h2>
                    <div class="bg-white border border-emerald-50 p-12 rounded-[3rem] shadow-sm flex flex-col items-center gap-6">
                       <div class="w-20 h-20 bg-emerald-50 rounded-3xl flex items-center justify-center text-emerald-600/60 rotate-6">
                          <i data-lucide="library-big" class="w-10 h-10"></i>
                       </div>
                       <div>
                        <p class="text-emerald-800/30 text-[10px] font-medium uppercase tracking-[0.2em] mb-2">Total Finished</p>
                        <h3 class="text-6xl font-semibold text-emerald-950 tracking-tighter">${finished} <span class="text-base font-normal text-emerald-200 tracking-normal ml-1">Books</span></h3>
                      </div>
                    </div>
                </div>
            `;
        }

        function renderBookDetail(book) {
            const detail = document.getElementById('book-detail');
            detail.innerHTML = `
                <div class="p-6 pt-12 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur-md z-10 border-b border-emerald-50">
                    <button onclick="toggleBookDetail(false)" class="w-10 h-10 bg-white rounded-2xl flex items-center justify-center border border-emerald-50 shadow-sm"><i data-lucide="chevron-left" class="w-4.5 h-4.5"></i></button>
                    <span class="text-[10px] font-semibold text-emerald-950 tracking-[0.3em] uppercase opacity-50">Book Archive</span>
                    <button onclick="deleteBook('${book.id}')" class="w-10 h-10 bg-white rounded-2xl flex items-center justify-center border border-rose-50 text-rose-300 shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
                
                <div class="p-6 space-y-12">
                    <div class="flex gap-8 items-start">
                        <img src="${book.cover}" class="w-32 h-44 object-cover rounded-[1.5rem] shadow-xl border-4 border-white">
                        <div class="flex-1 pt-2">
                            <h2 class="text-xl font-semibold leading-relaxed text-emerald-950 mb-1">${book.title}</h2>
                            <p class="text-emerald-700/40 font-medium text-[11px] mb-6 tracking-wide italic">${book.author}</p>
                            <div class="flex items-center gap-1.5 mb-8">
                                ${[1,2,3,4,5].map(s => `<i onclick="rateBook('${book.id}', ${s})" data-lucide="star" class="w-5 h-5 ${s <= book.rating ? 'text-amber-400 fill-amber-400' : 'text-emerald-50'}"></i>`).join('')}
                            </div>
                            <select onchange="updateStatus('${book.id}', this.value)" class="w-full bg-emerald-50/50 border border-emerald-50 rounded-xl py-3 px-4 font-medium text-[11px] text-emerald-800 tracking-widest uppercase outline-none">
                                <option value="${STATUS.WANT}" ${book.status === STATUS.WANT ? 'selected' : ''}>${STATUS.WANT}</option>
                                <option value="${STATUS.READING}" ${book.status === STATUS.READING ? 'selected' : ''}>${STATUS.READING}</option>
                                <option value="${STATUS.FINISHED}" ${book.status === STATUS.FINISHED ? 'selected' : ''}>${STATUS.FINISHED}</option>
                            </select>
                        </div>
                    </div>

                    <section class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-amber-50/50 relative">
                       <div class="flex justify-between items-center mb-6">
                         <h4 class="text-[10px] font-semibold text-amber-600 uppercase tracking-[0.25em] flex items-center gap-2">
                           <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> AI Insight
                         </h4>
                         ${!book.aiSummary ? `<button onclick="generateSummary('${book.id}')" class="px-4 py-2 bg-amber-500/10 text-amber-600 text-[10px] font-semibold rounded-xl tracking-wider">分析內容</button>` : ''}
                       </div>
                       <div id="ai-summary-text" class="text-[13px] text-emerald-900/60 leading-[1.8] font-normal whitespace-pre-wrap border-l border-amber-100/50 pl-5">
                         ${book.aiSummary || `<p class="text-[12px] text-emerald-800/20 italic text-center py-4">讓 AI 為您導讀核心內容</p>`}
                       </div>
                    </section>

                    <div class="bg-emerald-900/90 p-10 rounded-[3rem] text-white shadow-lg space-y-10">
                        <h4 class="text-[9px] font-medium text-emerald-300 uppercase tracking-[0.3em] flex items-center gap-2 opacity-50">
                          <i data-lucide="book-open" class="w-3 h-3"></i> Current Milestone
                        </h4>
                        <div class="flex items-center gap-10">
                           <div class="flex-1 flex flex-col items-center gap-4">
                              <input type="number" value="${book.currentPage}" onchange="updateProgress('${book.id}', this.value)" class="w-full bg-white/5 rounded-3xl py-5 px-2 font-semibold text-4xl text-white text-center shadow-inner border border-white/10 outline-none">
                              <span class="text-[8px] font-medium text-emerald-400 uppercase tracking-widest">Page Now</span>
                           </div>
                           <div class="text-emerald-700 font-light text-4xl">/</div>
                           <div class="flex-1 flex flex-col items-center gap-4">
                              <div class="w-full bg-emerald-950/20 rounded-3xl py-5 px-2 font-semibold text-4xl text-emerald-500/80 text-center border border-white/5">${book.pages}</div>
                              <span class="text-[8px] font-medium text-emerald-400 uppercase tracking-widest">Total Page</span>
                           </div>
                        </div>
                    </div>

                    <section class="space-y-6">
                      <div class="flex justify-between items-center px-2">
                        <h4 class="text-sm font-semibold text-emerald-950">隨手札記</h4>
                        <button onclick="beautifyNote('${book.id}')" class="flex items-center gap-1.5 px-4 py-2 bg-emerald-600/5 text-emerald-700 rounded-full text-[10px] font-semibold border border-emerald-100/30">
                            <i data-lucide="wand-2" class="w-3 h-3"></i> AI 修辭
                        </button>
                      </div>
                      <div class="bg-white p-2 rounded-[2.5rem] shadow-sm border border-emerald-50">
                        <textarea id="detail-note" placeholder="在此處記錄您的閱讀感悟..." class="w-full bg-transparent border-none rounded-3xl p-6 text-[14px] outline-none min-h-[180px] text-emerald-950/80 placeholder:text-emerald-100 leading-[1.8]"></textarea>
                        <button onclick="saveNote('${book.id}')" class="w-full py-5 bg-emerald-800 text-white rounded-[1.8rem] font-medium text-[13px] tracking-[0.2em] shadow-lg shadow-emerald-200 uppercase">儲存札記</button>
                      </div>
                      <div class="space-y-6 pt-4">
                        ${(book.notes || []).map(n => `
                            <div class="bg-white p-7 rounded-[2rem] border border-emerald-50/50 shadow-sm relative">
                                <p class="text-[14px] text-emerald-900/60 leading-[1.8] font-normal italic">「${n.text}」</p>
                                <div class="flex items-center gap-2 text-[9px] text-emerald-200 font-medium uppercase mt-5 pt-4 border-t border-emerald-50/50 tracking-widest">
                                  <i data-lucide="calendar" class="w-2.5 h-2.5"></i> ${n.date}
                                </div>
                            </div>
                        `).join('')}
                      </div>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Interaction Handlers ---
        function switchTab(tabId) {
            state.activeTab = tabId;
            render();
        }

        function toggleGoalSetter(show) {
            document.getElementById('goal-setter').classList.toggle('hidden', !show);
            document.getElementById('goal-value').innerText = state.yearlyGoal;
        }

        function adjustGoal(amt) {
            state.yearlyGoal = Math.max(1, state.yearlyGoal + amt);
            document.getElementById('goal-value').innerText = state.yearlyGoal;
            saveToStorage();
        }

        function toggleAiLoader(show) {
            state.isAiLoading = show;
            document.getElementById('ai-loader').classList.toggle('hidden', !show);
        }

        async function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value;
            if (!query.trim()) return;
            
            state.isSearching = true;
            render();

            try {
                const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
                const data = await res.json();
                state.searchResults = (data.items || []).map(item => ({
                    id: item.id,
                    title: item.volumeInfo.title,
                    author: item.volumeInfo.authors?.[0] || '未知作者',
                    cover: item.volumeInfo.imageLinks?.thumbnail || 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?auto=format&fit=crop&q=80&w=200',
                    pages: item.volumeInfo.pageCount || 200,
                    tags: [],
                    notes: []
                }));
            } catch (err) { console.error(err); } finally {
                state.isSearching = false;
                render();
            }
        }

        function addBook(id) {
            const found = state.searchResults.find(b => b.id === id);
            if (found && !state.books.find(b => b.id === id)) {
                state.books.push({ ...found, status: STATUS.WANT, currentPage: 0, rating: 0, dateAdded: new Date().toISOString() });
                saveToStorage();
                switchTab('library');
            }
        }

        function openBookDetail(id) {
            const book = state.books.find(b => b.id === id);
            if (book) {
                renderBookDetail(book);
                toggleBookDetail(true);
            }
        }

        function toggleBookDetail(show) {
            document.getElementById('book-detail').classList.toggle('hidden', !show);
        }

        function deleteBook(id) {
            if (confirm("確定移除這本書？")) {
                state.books = state.books.filter(b => b.id !== id);
                saveToStorage();
                toggleBookDetail(false);
                render();
            }
        }

        function rateBook(id, rating) {
            const book = state.books.find(b => b.id === id);
            if (book) {
                book.rating = rating;
                saveToStorage();
                renderBookDetail(book);
                render();
            }
        }

        function updateStatus(id, status) {
            const book = state.books.find(b => b.id === id);
            if (book) {
                if (status === STATUS.FINISHED && book.status !== STATUS.FINISHED) {
                    book.dateFinished = new Date().toISOString();
                }
                book.status = status;
                saveToStorage();
                render();
            }
        }

        function updateProgress(id, pages) {
            const book = state.books.find(b => b.id === id);
            if (book) {
                book.currentPage = Math.min(parseInt(pages) || 0, book.pages);
                saveToStorage();
                render();
            }
        }

        function saveNote(id) {
            const text = document.getElementById('detail-note').value;
            const book = state.books.find(b => b.id === id);
            if (book && text.trim()) {
                if (!book.notes) book.notes = [];
                book.notes.unshift({ id: Date.now(), text, date: new Date().toLocaleDateString() });
                saveToStorage();
                document.getElementById('detail-note').value = '';
                renderBookDetail(book);
            }
        }

        // --- AI Actions ---
        async function getRecommendations() {
            const finished = state.books.filter(b => b.status === STATUS.FINISHED).map(b => `《${b.title}》(${b.rating}星)`).join(', ');
            if (!finished) {
                alert("請先標記幾本完讀的書並評分。");
                return;
            }
            const prompt = `根據我已讀完的清單：[${finished}]，推薦 3 本我可能會感興趣的新書。提供書名、推薦原因、適合的心情。繁體中文，格式清晰。`;
            const result = await callGemini(prompt, "你是一位懂書的智慧導覽員。");
            if (result) {
                state.aiRecommendation = result;
                render();
            }
        }

        async function generateSummary(id) {
            const book = state.books.find(b => b.id === id);
            const prompt = `請為《${book.title}》提供約 300 字精華導讀。內容含：主題摘要、讀者建議、三個知識點。繁體中文，語氣溫暖。`;
            const result = await callGemini(prompt, "你是一位資深讀書博主。");
            if (result) {
                book.aiSummary = result;
                saveToStorage();
                renderBookDetail(book);
                render();
            }
        }

        async function beautifyNote(id) {
            const text = document.getElementById('detail-note').value;
            const book = state.books.find(b => b.id === id);
            if (!text.trim()) return;
            const prompt = `這是《${book.title}》的讀後感：『${text}』。請美化成結構化的書評摘要。`;
            const result = await callGemini(prompt, "你是一位文學評論家。");
            if (result) {
                document.getElementById('detail-note').value = result;
            }
        }

        // --- Init ---
        window.onload = () => {
            render();
        };
    </script>
</body>
</html>
